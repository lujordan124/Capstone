<html>
	<head>
		<title> ace </title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

		<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<link rel="stylesheet" href="test.css">

		<!-- jQuery library -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

		<!-- ACE -->
		<script src="ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

		<!-- Latest compiled JavaScript -->
		<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
		<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
		<link href='https://fonts.googleapis.com/css?family=Roboto+Condensed' rel='stylesheet' type='text/css'>
	</head>
	<body>
		<center>
			<div id = "problem" style="visibility:hidden">
				<h1 id = "problemNum"> Problem #1: [NAME OF PROBLEM] </h1>
				<div id = "description"> Description of problem here </div>
			</div>
			<button id = "fullscreen" class="btn btn-default" onclick="requestFullScreen(document.body)">START TEST</button>
		</center>
		<div id="countdown" style="visibility:hidden">
		</div>
		<div id = "bottom" style="visibility:hidden">
			<div id = "left">
				<h2 class = "pull-left"> Code here</h2>
				<button class="btn btn-default pull-right" id = "compile">SUBMIT</button>
				<pre id="editor"></pre><br>
			</div>
			<div id = "right">
				<h2> The results of the test </h2>
				<textarea id = "results">Hi</textarea>
			</div>

			<button class = "btn btn-default" id = "finish" onclick="finishTest(document.body)"> FINISH </button>
		</div>

		<script type="text/javascript">
		//determine if copied text was inside or outside window
		var copied = 0;

		//initialize editor
	    var editor = ace.edit("editor");	
	    editor.setTheme("ace/theme/twilight");
	    editor.getSession().setMode("ace/mode/c");
	    editor.getSession().on('change', function(e) {
	    	var startRow = e["start"]["row"];
	    	var startColumn = e["start"]["column"];
	    	var endRow = e["end"]["row"];
	    	var endColumn = e["end"]["column"];
	    	var action = e["action"];
	    	var lines = e["lines"];

	    	console.log(JSON.stringify(e));

	    	var keystrokeLog = "Start Row: " + startRow + " Start Column: " + startColumn + " End Row: " + endRow + " End Column: " + endColumn + " Action: " + action + " Lines: " + lines;

	    	//detection of copy/paste. only allowing copy and paste from current window.
	    	editor.commands.on("exec", function(e){
	    		if (e.command) {
	    			if(e.command.name == 'copy'){
	    				copied = 1;
	    			}
	    			if(e.command.name == 'paste'){
	    				if(copied == 0){
	    					e.preventDefault();
	    				}
	    			}
	    		}
	    	});
	    });

	    //initialize all buttons
		$(document).ready(function(){
			//on start quiz
			$('#startQuiz').click(function() {
				$.ajax({
			        type: "POST",
			        url: "getQuiz.php",
			        data: {quizNum: quizNum},
			        success: function(data){
			        	//retrieve quiz from database in JSON format
			        	document.getElementById("quizName").innerHTML = data.quizName;
			        	document.getElementById("questionName").innerHTML = data.questionName;
			        	document.getElementById("description").innerHTML = data.description;
			        	var timeAllowed = data.timeAllowed;
			        }
	    		});
			});
			//on submitting code
			$('#submitCode').click(function() {
				$.ajax({
					type: "POST",
			        url: "sendCode.php",
			        data: {code: code},
			        success: function(data){
			        	alert("DONE??");
			        }
	    		})
			});
			//on compilation
			$('#compile').click(function() {
				$.ajax({
					type: "POST",
			        url: "compileCode.php",
			        data: {code: code},
			        success: function(data){
			        	document.getElementById("result").innerHTML = data;
			        	alert("THE RESULTS OF THE COMPILATION?");
			        }
	    		})
			});
		});
		
		//detection of alt-tabbing
		$(window).focusin(function() {
			alert("I'M BACK");
		});
		$(window).blur(function(){
			alert("BLUR");
			copied = 0;
			// window.location.replace("offocus.php");
		});

		//full-screen change
		document.addEventListener("fullscreenchange", didChange);
		document.addEventListener("webkitfullscreenchange", didChange);
		document.addEventListener("mozfullscreenchange", didChange);
		
		//when test is finished
		function finishTest(element) {
	    	document.getElementById("bottom").style.visibility = "hidden";
			document.getElementById("problem").style.visibility = "hidden";
			document.getElementById('countdown').style.visibility = "hidden";
	    	document.webkitExitFullscreen();
			document.mozCancelFullscreen();
			document.exitFullscreen();
	    }

	    //if fullscreen changed
		function didChange() {
			// alert("ERROR!!!");
			var height = $(document).height();
			var sizeWin = window.innerWidth + " " + window.innerHeight;
			// alert(sizeWin);
			if (screen.width == window.innerWidth && screen.height == window.innerHeight) {
				alert("EXITED TESTING MODE");
				copied = 0;
			} else {
				// alert("ENTERED TESTING MODE");
			}
		}

		//force full screen
		function requestFullScreen(element) {
			var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
			if (requestMethod) {
				requestMethod.call(element);

				//TIMER FUNCTIONS
				var date = new Date().getTime();
				var timerTime =  date + (45 * 60 * 1000);

				setInterval(function() {
					var counterDate = new Date().getTime()
					var countdown = document.getElementById('countdown');
					var secondsLeft = timerTime - counterDate;

					var minutes = Math.floor(secondsLeft/60000);
					var seconds = ((secondsLeft%60000)/1000).toFixed(0);
					
					if (seconds > 10) {
						countdown.innerHTML = '' + minutes + ':' + seconds;
					} else {
						countdown.innerHTML = '' + minutes + ':0' + seconds;
					}
				}, 1000);

				document.getElementById("fullscreen").style.visibility = "hidden";
				document.getElementById("bottom").style.visibility = "visible";
				document.getElementById("problem").style.visibility = "visible";

			} else if (typeof window.ActiveXObject !== "undefined") {
				var wscript  = new ActiveXObject("WScript.Shell");
				if (wscript != null) {
					wscript.SendKeys("{F11}");
				}
			}
		}
		</script>
	</body>
</html>